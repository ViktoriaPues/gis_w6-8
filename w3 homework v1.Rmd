---
title: "w3 homework v1"
author: "Viktoria Pues"
date: "2023-11-08"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# w3 homework 

The task is to manipulate some raster data and produce some descriptive statistics. 

Background : Climatic models fed into the latest IPCC report, the models are divided into Shared Socioeconomic Pathways known as SSPs, ranging from SSP1 (lots of mitigation and adaption) to SSP5 (fossil fuel development). The Carbon Brief explainer has more information on the scenarios.

There are five SSPs, labeled SSP1 to SSP5, each representing a different narrative of global and regional development:

  SSP1: Sustainability – A world with rapidly declining population, high technology, and strong emphasis on environmental sustainability.
  SSP2: Middle of the Road – A world with moderate population and economic growth, with a focus on balanced development.
  SSP3: Regional Rivalry – A world with high population, low economic growth, and fragmented policies.
  SSP4: Inequality – A world with high population, low economic growth, and high inequality.
  SSP5: Fossil-fueled Development – A world with high population, high economic growth, and high fossil fuel use.

Task: For any country in the World (Bangladesh) produce descriptive statistics that show the difference in maximum temperature for key cities (Dhaka, Rajshahi) between SSP1 and SSP5 for the years 2081-2100, using any model and resolution.

Data: 
    WorldClim future projections #tif, downloaded the first model ACCESS-CM2
    Country outlines #geopackage 
    World city points # not sure if to download csv or shapefil 

## load libraries 
```{r}
library(here)
library(raster)
library(terra)
library(tidyverse)
library(janitor)
library(dplyr)
library(sf)
```

## read in the data 

### geopackage

quick look what is in the geopackage. how do i know which one to read in?
```{r}
st_layers(here("w 3 data homework","gadm41_BGD.gpkg"))
```

choosing the 0 layer and read it in 
```{r}
bangladesh_outline <- st_read("/Users/viktoriapues/Documents/casa/GIS /GIS Practicals/w3 practical v1/w 3 data homework/gadm41_BGD.gpkg", 
                      layer='ADM_ADM_0')
```
now check what the cordinate reference system is. It is WGS 84. 
```{r}
print(bangladesh_outline)
```
I am not sure if at this stage i need to change it to the bangladesh projected coordinate referene system. It looks normal when plotting it, so perhaps this is fine. 
```{r}
plot(bangladesh_outline)
```


### cities shapefile 

```{r}
cities <- sf::st_read(here("w 3 data homework","World_Cities.shp"))

```
### raster data 

make a list with the tif files in the folder 
```{r}
#listfiles<-dir_info("w 3 data homework/") %>% #this looks in the folder 
  #filter(str_detect(path, ".tif")) %>% #this filters the files that have "tif" in their name, hence string 
  #dplyr::select(path)%>% #this forces the select function from dplyr. The select() function is used to select the "path" column from the filtered file information. 
  #pull() #The pull fuction is used to extract the values from the "path" column and store them as a vector in the variable listfiles.

#have a look at the file names 
#listfiles # Displays the vector of file paths that match the filter criteria (i.e., files with ".tif" extension).
```

Then load all of the data straight into a SpatRaster. A SpatRaster is a collection of raster layers with the same spatial extent and resolution. Why do they need to be in a SpatRaster and not just seperate? 
```{r}
#max_temp <- listfiles %>%
  #terra::rast()
  
#have a look at the raster stack
#max_temp
```
tmax01 etc are months so we can rename them to make it more obvious. This does not work. It works with 24 namas. Leaving it for now. 
```{r}
# Create a vector of month names
#month <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
       #    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

# Assign the month names to the layers within the raster stack
#names(max_temp) <- month
#max_temp # check if it worked 
```
access just the data for tmax01 
```{r}
#max_temp$tmax01 #dollar sign means access
```



Trying to load in ssp1 and ssp5 seperately 
```{r}
ssp1 <- terra::rast(here("w 3 data homework", "wc2.1_2.5m_tmax_ACCESS-CM2_ssp126_2021-2040.tif"))

ssp5 <- terra::rast(here("w 3 data homework", "wc2.1_2.5m_tmax_ACCESS-CM2_ssp585_2021-2040.tif"))
```

look at ssp1 

```{r}
ssp1
```

```{r}
ssp5
```
check the raster cordinate reference system. it is also WGS 84

```{r}
crs(ssp1)
crs(ssp5)
```

## clean data 
select relevant cities in Bangldesh
```{r}
cities_bangladesh<- cities %>% 
  filter(CNTRY_NAME=='Bangladesh')
```
you need the difference between SP1 and SP5 for these 5 cities 
```{r}
ssp_diff <- ssp5 - ssp1 

ssp_diff
```


### join 

Clip the ssp layers to the Bangladesh outline 
```{r}
bangladesh_temp <- ssp_diff %>%
  # now crop our temp data to the extent
  terra::crop(., bangladesh_outline)

exact_bangladesh <- bangladesh_temp %>% # The mask, which is typically another raster layer or a polygon. Areas where the mask has values will be retained in the output, and areas where the mask has NA values will be set to NA in the output.
  terra::mask(.,bangladesh_outline)

  # plot the output
plot(exact_bangladesh)
```
these are the differences between SSP1 and SSP5 in Bangladesh. 

change names 

```{r}
month <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", 
           "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

names(exact_bangladesh) <- month

plot(exact_bangladesh)
```
extract data from the city points 

```{r}

cordinates_cities <- cities_bangladesh %>% mutate(lon = sf::st_coordinates(.)[,2],lat = sf::st_coordinates(.)[,1]) %>% select(lon,lat, CITY_NAME)

banglash_city_different<- terra::extract(exact_bangladesh,cordinates_cities) %>% cbind(CITY_NAME = cordinates_cities$CITY_NAME, .)

```

Now we have a data frame with the temperatures for 5 cities but lost the Name of the City, need to join this back to the Bangladesh citie df 

```{r}
#cities_bangladesh <- cities_bangladesh %>% select(.,-POP_RANK,-PORT_ID,-LABEL_FLAG) # I deleted the columns with single numebrs to not confuse with ID colum, cant run this twice so code this out  

cities_bangladesh_ID <- cities_bangladesh  %>% dplyr::mutate(join_id= 1:n())
```

## join

Now we can join this with the with bangladesh_city_difference that has the temperature data 
```{r}

column_names <- names(banglash_city_different)
colum_names_ID <- names(cities_bangladesh_ID)

print(column_names)
print(colum_names_ID)

bangladesh_city_diff_2 <- cities_bangladesh_ID %>% left_join(.,banglash_city_different, by=c('join_id'='ID'))
```
## plot
now you can plot for each city 
check where your columns wiht the months are 
```{r}
jan <- bangladesh_city_diff_2 %>% select(c(15))
dec <- bangladesh_city_diff_2 %>% select(c(26))
```

```{r}

#Drop the geometry and make a facet plot of differences per month
# all cities in spain where there is data

city_climate_diff <- bangladesh_city_diff_2 %>%
  dplyr::select(c(15:26))%>%
  sf::st_drop_geometry(.)%>%
  dplyr::as_tibble()

tidy_city_diff <- city_climate_diff %>%
  tidyr::pivot_longer(everything(), 
               names_to="Months", 
               values_to="temp_diff")

facet_plot <- tidy_city_diff %>%
  dplyr::mutate(Months = factor(Months, levels = c("Jan","Feb","Mar",
                                            "Apr","May","Jun",
                                            "Jul","Aug","Sep",
                                            "Oct","Nov","Dec")))
# Plot faceted histogram
plot<-ggplot(facet_plot, aes(x=temp_diff, na.rm=TRUE))+
  geom_histogram(color="black", binwidth = .1)+
  labs(title="Ggplot2 faceted difference in climate scenarios of max temp", 
       x="Temperature",
       y="Frequency")+
  facet_grid(Months ~ .)+
  theme(plot.title = element_text(hjust = 0.5))

plot
```